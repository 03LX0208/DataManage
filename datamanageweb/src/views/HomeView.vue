<template>
  <div id="all">
    <NavBar/>
    <div class="container" v-if="$store.state.user.identity === 'student'">
      <div class="row">
        <div class="col"></div>

        <div class="col-2">
          <n-list hoverable clickable style="margin-top: 20px;">
            <n-list-item>
              <n-thing title="ç›¸è§æ¨æ™š" content-style="margin-top: 10px;">
                å¥‹å‹‡å‘€ç„¶åä¼‘æ¯å‘€<br>
                å®Œæˆä½ ä¼Ÿå¤§çš„äººç”Ÿ
              </n-thing>
            </n-list-item>
            <n-list-item>
              <n-thing title="ç›¸è§æ¨æ™š" content-style="margin-top: 10px;">
                å¥‹å‹‡å‘€ç„¶åä¼‘æ¯å‘€<br>
                å®Œæˆä½ ä¼Ÿå¤§çš„äººç”Ÿ
              </n-thing>
            </n-list-item>
            <n-list-item>
              <n-thing title="ç›¸è§æ¨æ™š" content-style="margin-top: 10px;">
                å¥‹å‹‡å‘€ç„¶åä¼‘æ¯å‘€<br>
                å®Œæˆä½ ä¼Ÿå¤§çš„äººç”Ÿ
              </n-thing>
            </n-list-item>
            <n-list-item>
              <n-thing title="ç›¸è§æ¨æ™š" content-style="margin-top: 10px;">
                å¥‹å‹‡å‘€ç„¶åä¼‘æ¯å‘€<br>
                å®Œæˆä½ ä¼Ÿå¤§çš„äººç”Ÿ
              </n-thing>
            </n-list-item>
          </n-list>
        </div>

        <div class="col-6">
            <n-card
                title="ğŸ“– å¦‚ä½•æˆåŠŸ"
                embedded
                :bordered="false"
                style="margin-top: 20px; margin-bottom: 20px;"
                hoverable
            >
              å¦‚æœä½ å¹´è½»çš„æ—¶å€™ä¸ 996ï¼Œä½ ä»€ä¹ˆæ—¶å€™å¯ä»¥ 996ï¼Ÿä½ ä¸€è¾ˆå­æ²¡æœ‰
              996ï¼Œä½ è§‰å¾—ä½ å°±å¾ˆéª„å‚²äº†ï¼Ÿè¿™ä¸ªä¸–ç•Œä¸Šï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ªäººéƒ½å¸Œæœ›æˆåŠŸï¼Œéƒ½å¸Œæœ›ç¾å¥½ç”Ÿæ´»ï¼Œéƒ½å¸Œæœ›è¢«å°Šé‡ï¼Œæˆ‘è¯·é—®å¤§å®¶ï¼Œä½ ä¸ä»˜å‡ºè¶…è¶Šåˆ«äººçš„åŠªåŠ›å’Œæ—¶é—´ï¼Œä½ æ€ä¹ˆèƒ½å¤Ÿå®ç°ä½ æƒ³è¦çš„æˆåŠŸï¼Ÿ
            </n-card>
          <n-card
              title="â­ æˆ‘çš„æ”¶è—"
              embedded
              :bordered="false"
              hoverable
          >
            å¦‚æœä½ å¹´è½»çš„æ—¶å€™ä¸ 996ï¼Œä½ ä»€ä¹ˆæ—¶å€™å¯ä»¥ 996ï¼Ÿä½ ä¸€è¾ˆå­æ²¡æœ‰
            996ï¼Œä½ è§‰å¾—ä½ å°±å¾ˆéª„å‚²äº†ï¼Ÿè¿™ä¸ªä¸–ç•Œä¸Šï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ªäººéƒ½å¸Œæœ›æˆåŠŸï¼Œéƒ½å¸Œæœ›ç¾å¥½ç”Ÿæ´»ï¼Œéƒ½å¸Œæœ›è¢«å°Šé‡ï¼Œæˆ‘è¯·é—®å¤§å®¶ï¼Œä½ ä¸ä»˜å‡ºè¶…è¶Šåˆ«äººçš„åŠªåŠ›å’Œæ—¶é—´ï¼Œä½ æ€ä¹ˆèƒ½å¤Ÿå®ç°ä½ æƒ³è¦çš„æˆåŠŸï¼Ÿ
          </n-card>
          <div class="row">
            <div class="col">
              <n-card
                  title="ğŸ“– å¦‚ä½•æˆåŠŸ"
                  embedded
                  :bordered="false"
                  style="margin-top: 20px; margin-bottom: 20px;"
                  hoverable
              >
                å¦‚æœä½ å¹´è½»çš„æ—¶å€™ä¸ 996ï¼Œä½ ä»€ä¹ˆæ—¶å€™å¯ä»¥ 996ï¼Ÿä½ ä¸€è¾ˆå­æ²¡æœ‰
                996ï¼Œä½ è§‰å¾—ä½ å°±å¾ˆéª„å‚²äº†ï¼Ÿè¿™ä¸ªä¸–ç•Œä¸Šï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ªäººéƒ½å¸Œæœ›æˆåŠŸï¼Œéƒ½å¸Œæœ›ç¾å¥½ç”Ÿæ´»ï¼Œéƒ½å¸Œæœ›è¢«å°Šé‡ï¼Œæˆ‘è¯·é—®å¤§å®¶ï¼Œä½ ä¸ä»˜å‡ºè¶…è¶Šåˆ«äººçš„åŠªåŠ›å’Œæ—¶é—´ï¼Œä½ æ€ä¹ˆèƒ½å¤Ÿå®ç°ä½ æƒ³è¦çš„æˆåŠŸï¼Ÿ
              </n-card>
            </div>
            <div class="col">
              <n-card
                  title="ğŸ“– å¦‚ä½•æˆåŠŸ"
                  embedded
                  :bordered="false"
                  style="margin-top: 20px; margin-bottom: 20px;"
                  hoverable
              >
                å¦‚æœä½ å¹´è½»çš„æ—¶å€™ä¸ 996ï¼Œä½ ä»€ä¹ˆæ—¶å€™å¯ä»¥ 996ï¼Ÿä½ ä¸€è¾ˆå­æ²¡æœ‰
                996ï¼Œä½ è§‰å¾—ä½ å°±å¾ˆéª„å‚²äº†ï¼Ÿè¿™ä¸ªä¸–ç•Œä¸Šï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ªäººéƒ½å¸Œæœ›æˆåŠŸï¼Œéƒ½å¸Œæœ›ç¾å¥½ç”Ÿæ´»ï¼Œéƒ½å¸Œæœ›è¢«å°Šé‡ï¼Œæˆ‘è¯·é—®å¤§å®¶ï¼Œä½ ä¸ä»˜å‡ºè¶…è¶Šåˆ«äººçš„åŠªåŠ›å’Œæ—¶é—´ï¼Œä½ æ€ä¹ˆèƒ½å¤Ÿå®ç°ä½ æƒ³è¦çš„æˆåŠŸï¼Ÿ
              </n-card>
            </div>
          </div>
        </div>
        <div class="col"></div>
      </div>
    </div>

    <div class="container" v-if="$store.state.user.identity === 'admin'">
      <div class="row">
        <div class="col-12">
          <n-card content-style="" style="margin-top: 20px;">
            <n-tabs
                type="line"
                size="large"
                :tabs-padding="20"
                pane-style="padding: 20px;"
            >
              <n-tab-pane name="ç”¨æˆ·ç®¡ç†">
                <n-space justify="end">
                  <n-button class="" round size="large" type="info" @click="showAddUserModalBtn">
                    æ·»åŠ ç”¨æˆ·
                  </n-button>
                  <n-modal v-model:show="showAddUserModal">
                    <n-card
                        style="width: 1000px"
                        title="æ·»åŠ ç”¨æˆ·"
                        :bordered="false"
                        size="huge"
                        role="dialog"
                        aria-modal="true"
                    >
                      <template #header-extra>
                        è€å¿ƒå¡«å†™ä¿¡æ¯~
                      </template>
                      <n-space vertical>
                        èº«ä»½
                        <div class="row">
                          <div class="col-4">
                            <n-select placeholder="è¯·é€‰æ‹©å¯¹åº”èº«ä»½" v-model:value="userToBeAdd.identity" :options="identityOptions" />
                          </div>
                          <div class="col"></div>
                        </div>
                        <div v-if="userToBeAdd.identity === 'student'">
                          <div class="row">
                            <div class="col-4">
                              å§“å
                              <n-input placeholder="" v-model:value="userToBeAdd.student_name" maxlength="20" show-count clearable />
                            </div>
                            <div class="col-1"></div>
                            <div class="col-2">
                              æ€§åˆ«
                              <n-select placeholder="è¯·é€‰æ‹©" v-model:value="userToBeAdd.student_gender" :options="genderOptions" />
                            </div>
                            <div class="col-2">
                              å¹´é¾„
                              <n-input placeholder="" v-model:value="userToBeAdd.student_age" maxlength="3" show-count clearable />
                            </div>
                            <div class="col"></div>
                          </div>
                          <div class="row" style="margin-top: 6px;">
                            <div class="col-4">
                              æ•™å­¦å·
                              <n-input placeholder="çº¯æ•°å­—å“¦~" v-model:value="userToBeAdd.student_id" maxlength="20" show-count clearable />
                            </div>
                            <div class="col-1"></div>
                            <div class="col-4">
                              è”ç³»æ–¹å¼
                              <n-input placeholder="çº¯æ•°å­—å“¦~" v-model:value="userToBeAdd.student_telephone" maxlength="20" show-count clearable />
                            </div>
                            <div class="col"></div>
                          </div>
                          <div style="margin-top: 6px">å…¥å­¦æ—¶é—´</div>
                          <div class="row">
                            <div class="col-2">
                              <n-select placeholder="å¹´" v-model:value="userToBeAdd.year" :options="yearOptions"
                                        @update:value="updateOptions(userToBeAdd.year, userToBeAdd.month, 0)" />
                            </div>
                            <div class="col-2">
                              <n-select placeholder="æœˆ" v-model:value="userToBeAdd.month" :options="monthOptions"
                                        @update:value="updateOptions(userToBeAdd.year, userToBeAdd.month, 1)" />
                            </div>

                            <div class="col-2">
                              <n-select placeholder="æ—¥" v-model:value="userToBeAdd.day" :options="dayOptions" />
                            </div>

                            <div class="col"></div>
                          </div>
                          <div style="margin-top: 6px;">å­¦é™¢</div>
                          <div class="row">
                            <div class="col-6">
                              <n-select placeholder="è¯·é€‰æ‹©æ‰€å±å­¦é™¢~" v-model:value="userToBeAdd.faculty_id" :options="facultyOptions" />
                            </div>
                          </div>
                        </div>
                        <div v-if="userToBeAdd.identity === 'teacher'">
                          <div class="row">
                            <div class="col-4">
                              å§“å
                              <n-input placeholder="" v-model:value="userToBeAdd.teacher_name" maxlength="20" show-count clearable />
                            </div>
                            <div class="col-1"></div>
                            <div class="col-2">
                              æ€§åˆ«
                              <n-select placeholder="è¯·é€‰æ‹©" v-model:value="userToBeAdd.teacher_gender" :options="genderOptions" />
                            </div>
                            <div class="col-2">
                              å¹´é¾„
                              <n-input placeholder="" v-model:value="userToBeAdd.teacher_age" maxlength="3" show-count clearable />
                            </div>
                            <div class="col"></div>
                          </div>
                          <div class="row" style="margin-top: 6px;">
                            <div class="col-4">
                              æ•™å­¦å·
                              <n-input placeholder="çº¯æ•°å­—å“¦~" v-model:value="userToBeAdd.teacher_id" maxlength="20" show-count clearable />
                            </div>
                          </div>
                          <div class="row" style="margin-top: 6px;">
                            <div class="col-4">
                              è”ç³»æ–¹å¼
                              <n-input placeholder="çº¯æ•°å­—å“¦~" v-model:value="userToBeAdd.teacher_telephone" maxlength="20" show-count clearable />
                            </div>
                          </div>
                        </div>
                      </n-space>
                      <template #footer>
                        <n-space justify="end">
                          <n-button @click="addUser" strong secondary round type="primary">
                            ç¡®è®¤æ·»åŠ 
                          </n-button>
                        </n-space>
                      </template>
                    </n-card>
                  </n-modal>
                </n-space>
                <n-divider/>
                <AllUsers/>
              </n-tab-pane>
              <n-tab-pane name="åˆ«çš„">

              </n-tab-pane>
            </n-tabs>
          </n-card>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import NavBar from "@/components/NavBar"
import {NCard, NList, NListItem, NThing,  NTabs, NTabPane, NButton, NSpace, NDivider, NModal, NSelect, NInput, useMessage } from 'naive-ui';
import AllUsers from "@/components/admin/AllUsers";
import $ from 'jquery'
import {useStore} from "vuex";
import { ref, reactive } from 'vue';


export default {
  components: {
    NavBar,
    NCard,
    NList,
    NListItem,
    NThing,
    NTabs,
    NTabPane,
    NSpace,
    NButton,
    AllUsers,
    NDivider,
    NModal,
    NSelect,
    NInput,
  },

  setup() {
    const store = useStore();
    const message = useMessage();

    // æ·»åŠ ç”¨æˆ·
    let showAddUserModal = ref(false);
    let userToBeAdd = reactive({
      student_id: null,
      student_name: null,
      identity: null,
      student_gender: null,
      student_enter_date: null,
      student_age: null,
      student_telephone: null,
      faculty_id: null,
      teacher_id: null,
      teacher_name: null,
      teacher_gender: null,
      teacher_age: null,
      teacher_telephone: null,
      year: null,
      month: null,
      day: null,
    });
    let identityOptions = ref([
      {
        label: "å­¦ç”Ÿ",
        value: "student",
      },
      {
        label: "è€å¸ˆ",
        value: "teacher",
      },
      {
        label: "ç®¡ç†å‘˜",
        value: "admin",
      },
    ]);
    let genderOptions = ref([
      {
        label: "ç”·",
        value: "male",
      },
      {
        label: "å¥³",
        value: "female",
      }
    ]);
    let facultyOptions = ref([]);
    $.ajax({
      url: "https://data.lxcode.xyz/api/faculty/get-all/",
      type: "get",
      success(resp) {
        for (const fac of resp) {
          facultyOptions.value.push({
            label: fac.facultyName,
            value: fac.facultyId
          })
        }
      }
    })

    let yearOptions = ref([]);
    let monthOptions = ref([]);
    let dayOptions = ref([]);
    for (let i = 2000; i <= 2023; i++) yearOptions.value.push({
      label: i,
      value: i,
    });

    const updateOptions = (year, month, sig) => {
      // è·å–å½“å‰æ—¥æœŸ
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth() + 1;
      const currentDate = today.getDate();

      if (sig === 0) {
        userToBeAdd.month = null;
      } else userToBeAdd.day = null;

      // å¦‚æœé€‰æ‹©å¹´ä»½å¤§äºå½“å‰å¹´ä»½ï¼Œåˆ™åªèƒ½é€‰æ‹©1~12æœˆ
      if (year < currentYear) {
        monthOptions.value = [];
        for (let i = 1; i <= 12; i++) monthOptions.value.push({
          label: i,
          value: i,
        });
      } else {
        // å¦åˆ™å¦‚æœé€‰æ‹©å¹´ä»½ç­‰äºå½“å‰å¹´ä»½ï¼Œåˆ™åªèƒ½é€‰æ‹©å½“å‰æœˆä»½ä¹‹å‰çš„æœˆä»½
        monthOptions.value = [];
        for (let i = 1; i <= currentMonth; i++) monthOptions.value.push({
          label: i,
          value: i,
        });
      }

      // å¦‚æœé€‰æ‹©çš„æœˆä»½ç­‰äºå½“å‰æœˆä»½ï¼Œåˆ™åªèƒ½é€‰æ‹©å½“å‰æ—¥æœŸä¹‹å‰çš„æ—¥æœŸ
      if (year === currentYear && month === currentMonth) {
        dayOptions.value = [];
        for (let i = 1; i <= currentDate; i++) dayOptions.value.push({
          label: i,
          value: i,
        });
      } else {
        dayOptions.value = [];
        // å¦åˆ™æ ¹æ®æ‰€é€‰æœˆä»½è®¡ç®—å‡ºå¯ä»¥é€‰æ‹©çš„æ—¥æœŸèŒƒå›´
        const daysInMonth = new Date(year, month, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) dayOptions.value.push({
          label: i,
          value: i,
        });
      }
    }

    const addUser = () => {
      let enter_date = ref("");

      if (userToBeAdd.identity === "student") {
        if (userToBeAdd.day === null || userToBeAdd.month === null || userToBeAdd.year === null) {
          message.error("è¯·å°†å…¥å­¦æ—¥æœŸå®Œå–„ï¼");
          return;
        }
        enter_date.value += String(userToBeAdd.year);
        if (userToBeAdd.month < 10) {
          enter_date.value += "0" + String(userToBeAdd.month);
        } else enter_date.value += "0" + String(userToBeAdd.month);
        if (userToBeAdd.day < 10) {
          enter_date.value += "0" + String(userToBeAdd.day);
        } else enter_date.value += "0" + String(userToBeAdd.day);
      }

      $.ajax({
        url: "https://data.lxcode.xyz/api/admin/user/add/",
        type: "post",
        headers: {
          Authorization: "Bearer " + store.state.user.token,
        },
        data: {
          student_id: userToBeAdd.student_id,
          student_name: userToBeAdd.student_name,
          identity: userToBeAdd.identity,
          student_gender: userToBeAdd.student_gender,
          student_enter_date: enter_date.value,
          student_age: userToBeAdd.student_age,
          student_telephone: userToBeAdd.student_telephone,
          faculty_id: userToBeAdd.faculty_id,
          teacher_id: userToBeAdd.teacher_id,
          teacher_name: userToBeAdd.teacher_name,
          teacher_gender: userToBeAdd.teacher_gender,
          teacher_age: userToBeAdd.teacher_age,
          teacher_telephone: userToBeAdd.teacher_telephone,
        },
        success(resp) {
          if (resp.error_message === "success") {
            message.success("æ·»åŠ ç”¨æˆ·æˆåŠŸï¼");
            setTimeout(() => { location.reload(); }, 800);
          } else {
            message.error(resp.error_message);
          }
        }
      })
    };

    const showAddUserModalBtn = () => {
      showAddUserModal.value = true;
    }

    return {
      showAddUserModal,
      showAddUserModalBtn,
      userToBeAdd,
      identityOptions,
      genderOptions,
      yearOptions,
      monthOptions,
      dayOptions,
      updateOptions,
      addUser,
      facultyOptions,
    }
  }
}
</script>

<style scoped>
#all {
  min-height: 100vh;
  background-color: rgb(241,241,243);
}
</style>
